#-------------------------------------------------------------------------------
# Program: getDF.R
# Objective: transform data in suitable form for graph
# Authors: Chourrout Elise
# Creation: 15/02/2019
# Update:
#-------------------------------------------------------------------------------

##' @title Get Data from WS2 and formate them
##'
##' @importFrom phisWSClientR initializeClientConnection
##' @importFrom phisWSClientR getVariables2
##'
##' @param varURI uri of the variable to plot, from the \code{\link{listVariables}} function or the web service directly
##' @param varPretty from \code{\link{getVarPretty}}
##' @param token a token from \code{\link{getToken}} function
##'
##' @return WSResponse
##' @export
##'
##' @examples
##' \donttest{
##' initializeClientConnection(apiID="ws_private", url = "www.opensilex.org/openSilexAPI/rest/")
##'  aToken <- getToken("guest@opensilex.org","guest")
##'  token <- aToken$data
##'  varPrettyTot <- getVarPretty(token = token)
##'  getDataVarPretty(varURI = listVariables(token,
##'                   wsUrl="www.opensilex.org/openSilexAPI/rest/")$value[1],
##'                   varPretty = varPrettyTot,
##'                   token = token)
##' }
getDataVarPretty <- function(varURI, varPretty, token) {

  # Recuperation of the uri of the variable of interest
  numVar <- match(varURI, varPretty$uri)

  nameUriVar <-  varPretty$uri[numVar]

  # Recuperation of the data from the WS
  myCount <- phisWSClientR::getEnvironmentData(token = token, variable = varURI)$totalCount
  enviroData <- phisWSClientR::getEnvironmentData(token = token, variable =  varURI, verbose = TRUE, pageSize = myCount)$data

  # Creation of the dataTable to return
  nomVar <- paste(toupper(substr(varPretty$name[numVar],1,1)), substr(varPretty$name[numVar],2,nchar(varPretty$name[numVar])), sep = "")
  methodVar <- as.character(varPretty$method[numVar])
  acronymVar <- as.character(varPretty$acronym[numVar])
  unityVar <- as.character(varPretty$unity[numVar])
  varPretty <- list(name = nomVar, method = methodVar, acronym = acronymVar, unity = unityVar)

  return(list(enviroData = enviroData, varPretty = varPretty))
}
